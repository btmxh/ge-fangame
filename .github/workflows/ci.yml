name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  pre-commit-checks:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Run pre-commit checks
        run: nix flake check

  build-host:
    name: Build for Host (x86_64-linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Build for host (with dummy SDL backend)
        run: |
          nix develop --command bash -c '
            # Configure with headless/offscreen SDL settings
            export SDL_VIDEODRIVER=dummy
            export SDL_AUDIODRIVER=dummy

            # Build using CMake
            cmake -S. -Bbuild -DCMAKE_BUILD_TYPE=Release
            cmake --build build --verbose

            # Verify the binary was created
            ls -lh build/bin/ge-app
          '

      - name: Upload host build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ge-app-x86_64-linux
          path: build/bin/ge-app
          retention-days: 7

  build-arm:
    name: Build for ARM (STM32)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Build for ARM/STM32 (cross-compilation)
        run: |
          nix develop --command bash -c '
            # Note: STM32 build is not yet fully supported in CMakeLists.txt
            # The ge-hal/CMakeLists.txt shows a FATAL_ERROR for GE_HAL_STM32
            # This job will succeed when that expected error occurs

            # Use the ARM embedded toolchain
            export CC=arm-none-eabi-gcc
            export CXX=arm-none-eabi-g++

            # Try to configure for ARM cross-compilation
            if cmake -S. -Bbuild-arm \
              -DCMAKE_BUILD_TYPE=Release \
              -DGE_HAL_STM32=ON \
              -DCMAKE_SYSTEM_NAME=Generic \
              -DCMAKE_SYSTEM_PROCESSOR=arm \
              -DCMAKE_C_COMPILER=arm-none-eabi-gcc \
              -DCMAKE_CXX_COMPILER=arm-none-eabi-g++ \
              2>&1 | tee cmake-output.txt; then
              # Configuration succeeded, try to build
              echo "Configuration succeeded, building..."
              cmake --build build-arm --verbose
            else
              # Check if failure is expected STM32 unsupported error
              if grep -q "STM32 platform not yet supported" \
                cmake-output.txt; then
                echo "Expected: STM32 support not yet implemented"
                exit 0
              else
                # Unexpected error, fail the job
                echo "Unexpected configuration error!"
                cat cmake-output.txt
                exit 1
              fi
            fi
          '

      - name: Upload ARM build artifact (if exists)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ge-app-arm-stm32
          path: build-arm/bin/*
          if-no-files-found: ignore
          retention-days: 7
